#!/bin/bash
#
# Pre-commit hook for documentation validation
#
# Validates:
# - No unreplaced placeholders ({{...}})
# - Conventional commit message format (enforced at commit-msg hook)
# - Markdown syntax (if markdownlint available)
# - No secrets in .env.local files
#
# Installation:
#   git config core.hooksPath .githooks
#
# Author: Template System
# Created: 2025-11-02

set -e

echo "ðŸ” Running pre-commit validation..."

# Check for unreplaced placeholders (exclude .githooks/ directory and GitHub Actions syntax)
echo "  Checking for unreplaced placeholders..."
STAGED_FILES=$(git diff --cached --name-only | grep -v "^\.githooks/" || true)
if [ -n "$STAGED_FILES" ]; then
    # Look for {{ but exclude ${{ (GitHub Actions syntax)
    if echo "$STAGED_FILES" | xargs grep -l "[^$]{{" 2>/dev/null; then
        echo "âŒ ERROR: Found unreplaced placeholders in staged files:"
        echo "$STAGED_FILES" | xargs grep -n "[^$]{{"
        echo ""
        echo "Please replace all {{PLACEHOLDER}} values before committing."
        exit 1
    fi
fi

# Check for secrets in .env.local
if git diff --cached --name-only | grep -q "\.env\.local"; then
    echo "âŒ ERROR: Attempting to commit .env.local file"
    echo ""
    echo ".env.local should never be committed (contains secrets)."
    echo "This file is in .gitignore. Please unstage it:"
    echo "  git reset HEAD .env.local"
    exit 1
fi

# Check markdown syntax (if markdownlint is available)
if command -v markdownlint &> /dev/null; then
    echo "  Checking markdown syntax..."
    MD_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "\.md$" || true)
    if [ -n "$MD_FILES" ]; then
        if ! echo "$MD_FILES" | xargs markdownlint --config .markdownlint.json 2>/dev/null; then
            echo "âš ï¸  WARNING: Markdown linting issues found (not blocking commit)"
        fi
    fi
fi

# Validate daily practices (strict mode)
if [ -f "scripts/validate-daily-practices.sh" ]; then
    echo "  Checking daily practices..."
    if bash scripts/validate-daily-practices.sh 2>&1; then
        echo "  âœ… Daily practices validated"
    else
        echo ""
        echo "To bypass daily practices check (not recommended):"
        echo "  git commit --no-verify"
        exit 1
    fi
fi

echo "âœ… Pre-commit validation passed"
exit 0
