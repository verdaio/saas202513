#!/bin/bash
# VERDAIO_BASELINE_BYPASS_BEGIN
# Fleet Ops Baseline Commit Bypass (v1)
# This block allows baseline automation to commit specific files without
# triggering the rest of the pre-commit hook. Normal commits are unaffected.
#
# Usage: VERDAIO_BASELINE_COMMIT=1 git commit -m "baseline: ..."
# Docs:  docs/ops/GIT-HOOKS-BASELINE.md
#
if [ "$VERDAIO_BASELINE_COMMIT" = "1" ]; then
  # Get list of staged files
  STAGED_FILES=$(git diff --cached --name-only)

  # Define allowlist patterns (baseline artifacts only)
  # Root-level baseline artifacts
  ALLOWLIST_EXACT="docker-compose.local.yml LOCAL-DEV-BOOTSTRAP.md LOCAL-DEV-BOOTSTRAP.VERSION .env.example .gitignore README.md STATUS.md CHANGELOG.md AI-UPGRADES-LOG.md"
  # Directory prefixes
  ALLOWLIST_PREFIXES="docs/ .github/workflows/ scripts/ci/ scripts/dev/ .githooks/"

  DISALLOWED=""
  for file in $STAGED_FILES; do
    ALLOWED=0

    # Check exact matches
    for allowed_file in $ALLOWLIST_EXACT; do
      if [ "$file" = "$allowed_file" ]; then
        ALLOWED=1
        break
      fi
    done

    # Check prefix matches
    if [ "$ALLOWED" = "0" ]; then
      for prefix in $ALLOWLIST_PREFIXES; do
        case "$file" in
          $prefix*) ALLOWED=1; break ;;
        esac
      done
    fi

    # Track disallowed files
    if [ "$ALLOWED" = "0" ]; then
      DISALLOWED="$DISALLOWED $file"
    fi
  done

  if [ -n "$DISALLOWED" ]; then
    echo "[VERDAIO_BASELINE_BYPASS] ERROR: The following files are not allowed in baseline commits:"
    for file in $DISALLOWED; do
      echo "  - $file"
    done
    echo ""
    echo "Baseline commits may only include: docs, CI/scripts, and root config files."
    echo "For code changes, remove VERDAIO_BASELINE_COMMIT=1 and run the full hook."
    exit 1
  fi

  echo "[VERDAIO_BASELINE_BYPASS] Baseline commit allowed. Staged files:"
  for file in $STAGED_FILES; do
    echo "  - $file"
  done
  exit 0
fi
# VERDAIO_BASELINE_BYPASS_END

#
# Pre-commit hook for documentation validation
#
# Validates:
# - No unreplaced placeholders ({{...}})
# - Conventional commit message format (enforced at commit-msg hook)
# - Markdown syntax (if markdownlint available)
# - No secrets in .env.local files
#
# Installation:
#   git config core.hooksPath .githooks
#
# Author: Template System
# Created: 2025-11-02

set -e

echo "üîç Running pre-commit validation..."

# Check for unreplaced placeholders (exclude .githooks/ directory and GitHub Actions syntax)
echo "  Checking for unreplaced placeholders..."
STAGED_FILES=$(git diff --cached --name-only | grep -v "^\.githooks/" || true)
if [ -n "$STAGED_FILES" ]; then
    # Look for {{ but exclude ${{ (GitHub Actions syntax)
    if echo "$STAGED_FILES" | xargs grep -l "[^$]{{" 2>/dev/null; then
        echo "‚ùå ERROR: Found unreplaced placeholders in staged files:"
        echo "$STAGED_FILES" | xargs grep -n "[^$]{{"
        echo ""
        echo "Please replace all {{PLACEHOLDER}} values before committing."
        exit 1
    fi
fi

# Check for secrets in .env.local
if git diff --cached --name-only | grep -q "\.env\.local"; then
    echo "‚ùå ERROR: Attempting to commit .env.local file"
    echo ""
    echo ".env.local should never be committed (contains secrets)."
    echo "This file is in .gitignore. Please unstage it:"
    echo "  git reset HEAD .env.local"
    exit 1
fi

# Check markdown syntax (if markdownlint is available)
if command -v markdownlint &> /dev/null; then
    echo "  Checking markdown syntax..."
    MD_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "\.md$" || true)
    if [ -n "$MD_FILES" ]; then
        if ! echo "$MD_FILES" | xargs markdownlint --config .markdownlint.json 2>/dev/null; then
            echo "‚ö†Ô∏è  WARNING: Markdown linting issues found (not blocking commit)"
        fi
    fi
fi

echo "‚úÖ Pre-commit validation passed"
exit 0
